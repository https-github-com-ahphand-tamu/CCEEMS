<!DOCTYPE html>
<html lang="en"  data-bs-theme="dark">
<head>
  <title>Home Page</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel=""stylesheet href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/homepage.css') }}"  />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
</head>
<body>
  <div class="container">
    <nav>
      <div class="nav-menu">
        <div class="nav-title">
          <a href="./home-page"><img src="{{ url_for('static', filename='images/ccgrouplogo.png') }}" width="250"></a>
        </div>
        <ul>
          <li><a href="./home-page">
            <i class="fa-solid fa-chart-simple"></i>
            <span class="page">Home Page</span>
          </a>
          </li>
          <li><a href="./users">
            <i class="fa-solid fa-user"></i>
            <span class="page">Users</span>
          </a>
          <li><a href="./manage-users">
            <i class="fa-solid fa-user-gear"></i>
            <span class="page">Manage Users</span>
          </a>
          </li>
          <li><a href="./upload-new-requests">
            <i class="fa-solid fa-upload"></i>
            <span class="page">Upload New Cases</span>
          </a>
          </li>
          <li><a href="./new-requests">
            <i class="fa-solid fa-clipboard-list"></i>
            <span class="page">Assign Cases</span>
          </a>
          </li>
          </li>
          <li><a href="./">
            <i class="fas fa-sign-out-alt"></i>
            <span class="page">Logout</span>
          </a>
          </li>
        </ul>
      </div>
    </nav>

    <section class="main">
      <div class="main-top">
        <h1>ChildCare Enrollment Management System</h1>
      </div>
      <style>
        /* Custom CSS for the purple table and button */
        .purple-table  {
            background-color: purple;
            color: white;
        }

        .purple-button {
            background-color: purple;
            color: white;
            border: none;
        }

        .purple-button:hover {
            background-color: darkpurple;
        }
      </style>
    <h1>Cases</h1>
    <div class="container">
        <table id="casesTable" contenteditable="true" class="table table-bordered table-striped resizable-table display">
            <thead class="thead-dark purple-table">
                <tr class="row-exclude">
                    <th>ID</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>No.of Children</th>
                    <th>Outreach Date</th>
                    <th>Packet Return Status</th>
                    <th>Packet Received Date</th>
                    <th>Staff Intials</th>
                    <th>Decision</th>
                    <th>No. of Children Enrolled</th>
                    <th>Decision Date</th>
                    <th>Not Enrolled Reason</th>
                    <th>Assigned To User</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for case in cases %}
                    <tr>
                        <td class="exclude">{{ case.customer_id }}</td>
                        <td>{{ case.first_name }}</td>
                        <td>{{ case.last_name }}</td>
                        <td>{{ case.num_of_children }}</td>
                        <td class="exclude">
                            <div class="input-group">
                                <input type="text" class="form-control datepicker" id="outreach_date_{{ case.id }}" value="{{ case.outreach_date }}">
                                <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fas fa-calendar-alt"></i>
                                    </span>
                                </div>
                            </div>
                        </td>
                                                <td>{{ case.packet_return_status.value }}</td>
                        <td>{{ case.packet_received_date }}</td>
                        <td class="exclude">{{ case.staff_initials }}</td>
                        <td>{{ case.decision.value }}</td>
                        <td>{{ case.num_children_enrolled }}</td>
                        <td>{{ case.decision_date }}</td>
                        <td>{{ case.not_enrolled_reason }}</td>
                        <td class="exclude">{{ case.assigned_to_user }}</td>
                        <td>
                            <!-- Button to trigger the modal -->
                            <button class="btn purple-button btn-primary assign-button" data-toggle="modal" data-target="#assignModal{{ case.id }}" data-case-id="{{ case.id }}">
                                Assign
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>


    <!-- Modal for assignment -->
    <div class="modal fade" id="assignModal" tabindex="-1" role="dialog" aria-labelledby="assignModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignModalLabel">Assign Request</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="assignForm">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="user_id">Select User:</label>
                            <select class="form-control" id="user_id" name="user_id">
                                {% for user in users %}
                                    <option value="{{ user.id }}">{{ user.name }}</option>
                                {% endfor %}
                            </select>
                            <input type="hidden" id="case_id" name="case_id" value="">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="assignSubmit">Assign Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript to handle the assignment -->
    <script>
    document.querySelectorAll('.assign-button').forEach(function(button) {
        let table = new DataTable('#casesTable');
        var excludeElements = document.querySelectorAll('.exclude');
        excludeElements.forEach(function(element) {
            element.contentEditable = 'false';
        });
        // document.querySelector('.row-exclude')

        button.addEventListener('click', function() {
            // Extract the request ID from the button's data attribute
            var case_id = this.getAttribute('data-case-id');
            $(this).attr('data-target', '#assignModal' + case_id);
            $('#assignmodal').attr('id', '#assignModal' + case_id);
            console.log("CLICKED " + '#assignModal' + case_id);
                // When the modal is shown, set the requestId in the modal form
                $('#assignModal').on('show.bs.modal', function(event) {
                    console.log("MODAL SHOWN");
                    var modal = $(this);
                    modal.find('#case_id').val(case_id);
                });
            // Show the modal after the event binding
            $('#assignModal').modal('show');
        });

        // Initialize the Bootstrap Datepicker
        $('.datepicker').datepicker({
            format: 'yyyy-mm-dd', // Set the desired date format
            todayBtn: 'linked',
            autoclose: true,
        });

    });

        // Handle the assignment when the "Assign Request" button in the modal is clicked
        $('#assignSubmit').on('click', function() {
            var case_id = $('#case_id').val();
            var selectedUserId = $('#user_id').val();

            $.ajax({
                type: 'POST',
                url: '/assign_request/' + case_id,
                data: { user_id: selectedUserId },
                success: function(response) {
                    // Handle the response as needed, e.g., display a success message
                    alert('Request assigned successfully.');
                    $('#assignModal' + requestId).modal('hide');
                    location.reload(); // Optionally, reload the page or update the UI
                },
                error: function(error) {
                    console.error('Error:', error);
                    alert('Error assigning request' + error.message);
                }
            });
        });
    </script>
    </section>
  </div>
</body>
</html>
