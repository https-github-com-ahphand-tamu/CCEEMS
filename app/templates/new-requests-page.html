<!DOCTYPE html>
<html lang="en">
<head>
  <title>Home Page</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter&family=Poppins:wght@400;700&display=swap" rel="stylesheet"> 
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='fonts/fontawesome-free-6.4.2-web/css/all.min.css') }}" />
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/homepage.css') }}"  />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
  <div class="container">
    <nav>
      <div class="nav-menu">
        <div class="nav-title">
          <a href="./home-page"><img src="{{ url_for('static', filename='images/ccgrouplogo.png') }}" width="250"></a>
        </div>
        <ul>
          <li><a href="./home-page">
            <i class="fa-solid fa-chart-simple"></i>
            <span class="page">Home Page</span>
          </a>
          </li>
          <li><a href="./users">
            <i class="fa-solid fa-user"></i>
            <span class="page">Users</span>
          </a>
          <li><a href="./manage-users">
            <i class="fa-solid fa-user-gear"></i>
            <span class="page">Manage Users</span>
          </a>
          </li>
          <li><a href="./upload-new-requests">
            <i class="fa-solid fa-upload"></i>
            <span class="page">Upload New Cases</span>
          </a>
          </li>
          <li><a href="./new-requests">
            <i class="fa-solid fa-clipboard-list"></i>
            <span class="page">Assign Cases</span>
          </a>
          </li>        
          </li>
          <li><a href="./">
            <i class="fas fa-sign-out-alt"></i>
            <span class="page">Logout</span>
          </a>
          </li>
        </ul>
      </div>
    </nav>

    <section class="main">
      <div class="main-top">
        <h1>ChildCare Enrollment Management System</h1>
      </div>
      <style>
        /* Custom CSS for the purple table and button */
        .purple-table  {
            background-color: purple;
            color: white;
        }

        .purple-button {
            background-color: purple;
            color: white;
            border: none;
        }

        .purple-button:hover {
            background-color: darkpurple;
        }
      </style>
    <div class="container">
        <h1>New Requests</h1>
        <table class="table table-bordered table-striped">
            <thead class="thead-dark purple-table">
                <tr>
                    <th>ID</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for request in new_requests %}
                    <tr>
                        <td>{{ request.customer_id }}</td>
                        <td>{{ request.first_name }}</td>
                        <td>{{ request.last_name }}</td>
                        <td>
                            <!-- Button to trigger the modal -->
                            <button class="btn purple-button btn-primary assign-button" data-toggle="modal" data-target="#assignModal{{ request.id }}" data-request-id="{{ request.id }}">
                                Assign
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>


    <!-- Modal for assignment -->
    <div class="modal fade" id="assignModal" tabindex="-1" role="dialog" aria-labelledby="assignModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignModalLabel">Assign Request</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="assignForm">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="user_id">Select User:</label>
                            <select class="form-control" id="user_id" name="user_id">
                                {% for user in users %}
                                    <option value="{{ user.id }}">{{ user.name }}</option>
                                {% endfor %}
                            </select>
                            <input type="hidden" id="request_id" name="request_id" value="">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="assignSubmit">Assign Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript to handle the assignment -->
    <script>
    document.querySelectorAll('.assign-button').forEach(function(button) {
        button.addEventListener('click', function() {
            // Extract the request ID from the button's data attribute
            var requestId = this.getAttribute('data-request-id');
            $(this).attr('data-target', '#assignModal' + requestId);
            $('#assignmodal').attr('id', '#assignModal' + requestId);
            console.log("CLICKED " + '#assignModal' + requestId);
                // When the modal is shown, set the requestId in the modal form
                $('#assignModal').on('show.bs.modal', function(event) {
                    console.log("MODAL SHOWN");
                    var modal = $(this);
                    modal.find('#request_id').val(requestId);
                });
            // Show the modal after the event binding
            $('#assignModal').modal('show');
        });
    });

        // Handle the assignment when the "Assign Request" button in the modal is clicked
        $('#assignSubmit').on('click', function() {
            var requestId = $('#request_id').val();
            var selectedUserId = $('#user_id').val();
    
            // Make an AJAX request to the /assign_request/<request_id> endpoint
            // with the selected user ID
            $.ajax({
                type: 'POST',
                url: '/assign_request/' + requestId,
                data: { user_id: selectedUserId },
                success: function(response) {
                    // Handle the response as needed, e.g., display a success message
                    alert('Request assigned successfully.');
                    $('#assignModal' + requestId).modal('hide');
                    location.reload(); // Optionally, reload the page or update the UI
                },
                error: function(error) {
                    console.error('Error:', error);
                    alert('Error assigning request.');
                }
            });
        });
    </script>
    </section>
  </div>
</body>
</html>